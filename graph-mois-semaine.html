</html><!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heatmap Spotify</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        canvas {
            margin: 20px auto;
            display: block;
        }
        #selectors {
            margin: 20px 0;
        }
        select, button {
            margin: 10px;
            padding: 10px;
        }
        .controls {
            margin: 20px 0;
        }
        .controls label {
            font-size: 16px;
            font-weight: bold;
            margin-right: 10px;
        }
        #heatmap {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            display: none;
            font-family: Arial, sans-serif;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="controls">
        <label for="month-select">Choisissez un mois :</label>
        <select id="month-select"></select>
    </div>
    <div class="title">Heatmap des heures d'écoute</div>
    <div id="heatmap"></div>
    <div class="tooltip"></div>


<script>
    const files = [
        "https://raw.githubusercontent.com/heidisbk/SpotifyDataViz/refs/heads/develop/Documents/dataviz/projet/Spotify_Account_Data_Clarence/StreamingHistory_music_1.json",
        "https://raw.githubusercontent.com/heidisbk/SpotifyDataViz/refs/heads/develop/Documents/dataviz/projet/Spotify_Account_Data_Clarence/StreamingHistory_music_0.json"
    ];

    const days = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
    const weeks = Array.from({ length: 5 }, (_, i) => `Semaine ${i + 1}`);
    let allData = [];

    Promise.all(files.map(url => fetch(url).then(resp => resp.json())))
        .then(dataArrays => {
            allData = dataArrays.flat();
            console.log("Données chargées :", allData);
            populateMonths(allData);
            updateHeatmap(getDataByMonth(allData, getSelectedMonth()));
        });

    function populateMonths(data) {
        const months = new Set(
            data.map(entry => {
                const date = new Date(entry.endTime);
                return date.toISOString().slice(0, 7); // YYYY-MM format
            })
        );

        const monthSelect = d3.select("#month-select");
        monthSelect
            .selectAll("option")
            .data([...months].sort())
            .join("option")
            .attr("value", d => d)
            .text(d => d);

        monthSelect.on("change", () => {
            const selectedMonth = getSelectedMonth();
            const filteredData = getDataByMonth(allData, selectedMonth);
            updateHeatmap(filteredData);
        });
    }

    function getSelectedMonth() {
        return d3.select("#month-select").node().value;
    }

    function getDataByMonth(data, month) {
        return data.filter(entry => {
            const date = new Date(entry.endTime);
            return date.toISOString().slice(0, 7) === month;
        });
    }

    function aggregateDataByMonth(data) {
        const aggregated = {};

        data.forEach(entry => {
            const date = new Date(entry.endTime);
            const week = Math.ceil(date.getDate() / 7) - 1; // 0-based week index
            const day = date.getDay(); // 0 = Sunday, 6 = Saturday
            const key = `${week}-${day}`;

            if (!aggregated[key]) {
                aggregated[key] = 0;
            }
            aggregated[key] += entry.msPlayed;
        });

        return weeks.flatMap((week, wIndex) =>
            days.map((day, dIndex) => ({
                week,
                day,
                value: aggregated[`${wIndex}-${dIndex}`] || 0
            }))
        );
    }

    function updateHeatmap(data) {
        const aggregatedData = aggregateDataByMonth(data);
        console.log("Données agrégées :", aggregatedData);

        const margin = { top: 50, right: 20, bottom: 50, left: 150 };
        const width = 800 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        d3.select("#heatmap").selectAll("*").remove();

        const svg = d3.select("#heatmap")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

        const xScale = d3.scaleBand()
            .domain(days)
            .range([0, width])
            .padding(0.05);

        const yScale = d3.scaleBand()
            .domain(weeks)
            .range([0, height])
            .padding(0.05);

        const colorScale = d3.scaleSequential(d3.interpolateBlues)
            .domain([0, d3.max(aggregatedData, d => d.value)]);

        const tooltip = d3.select(".tooltip");

        svg.selectAll("rect")
            .data(aggregatedData)
            .join("rect")
            .attr("x", d => xScale(d.day))
            .attr("y", d => yScale(d.week))
            .attr("width", xScale.bandwidth() - 5)
            .attr("height", yScale.bandwidth() - 5)
            .attr("fill", d => colorScale(d.value))
            .on("mouseover", (event, d) => {
                const totalSeconds = Math.floor(d.value / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                tooltip
                    .style("display", "block")
                    .style("left", event.pageX + 10 + "px")
                    .style("top", event.pageY - 10 + "px")
                    .html(`
                        <strong>Semaine :</strong> ${d.week}<br>
                        <strong>Jour :</strong> ${d.day}<br>
                        <strong>Temps :</strong> ${hours}h ${minutes}m ${seconds}s
                    `);
            })
            .on("mouseout", () => tooltip.style("display", "none"));

        svg.append("g")
            .call(d3.axisTop(xScale))
            .attr("transform", `translate(0, 0)`);

        svg.append("g")
            .call(d3.axisLeft(yScale));
    }
</script>
</body>
</html>
